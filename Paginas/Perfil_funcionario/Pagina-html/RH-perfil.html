<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Funcionário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../Pagina-css/Funcionario-Perfil.css">
</head>
<body>
    <div class="container mt-3">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="position-relative">
                    <img id="foto-perfil" src="/midia/fotooriginal.png" alt="Foto de Perfil" class="img-fluid rounded-4" style="max-width: 310px; height: 300px;">
                    <button id="editar-foto" class="btn btn-light position-absolute" style="top: 8px; right: 115px;" title="Editar Foto" onclick="document.getElementById('input-foto').click();">
                        <i class="bi bi-camera fs-5"></i>
                    </button>
                    <form id="form-foto" style="display: none;">
                        <input type="file" id="input-foto" name="fotoPerfil" accept="image/*" onchange="uploadImage()">
                    </form>
                </div>

                <!-- Contato -->
                <div class="card mt-2 bg-light-purple" style="border-radius: 40px; max-width: 310px; height: 120px;">
                    <div class="card-header text-white text-center bg-purple fs-5" style="border-radius: 40px 40px 0 0;">
                        <i class="bi bi-telephone fs-4 position-absolute" style="left: 15px;"></i>
                        <span>Contato</span>
                        <button class="btn btn-light position-absolute" style="right: 15px;" title="Editar Contato" onclick="openEditModal('contato')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body text-center text-dark">
                        <p id="contato">Carregando...</p>
                    </div>
                </div>

                <!-- Horário de trabalho -->
                <div class="card mt-2 bg-light-purple" style="border-radius: 40px; max-width: 310px; height: 120px;">
                    <div class="card-header text-white text-center bg-purple fs-5" style="border-radius: 40px 40px 0 0;">
                        <i class="bi bi-clock fs-4 position-absolute" style="position: absolute; left: 15px;"></i> Horário de Trabalho
                        <button class="btn btn-light position-absolute" style="right: 15px;"  title="Editar Horário" onclick="openEditModal('turno')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body text-center text-dark">
                        <p id="turno">Carregando...</p>
                    </div>
                </div>

                <!-- Código do Funcionário -->
                <div class="card mt-2 bg-danger" style="border-radius: 40px; max-width: 310px; height: 120px;"> 
                    <div class="card-header text-white text-center bg-purple fs-5" style="border-radius: 40px 40px 0 0;">
                        <i class="bi bi-person-badge-fill fs-4" style="position: absolute; left: 15px;"></i>
                        Código
                        <button class="btn btn-light position-absolute" style="right: 15px;" title="Editar Código" onclick="openEditModal('codigoFuncionario')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body text-center text-dark">
                        <p id="codigoFuncionario">Carregando...</p>
                    </div>
                </div>

                <!-- Botão de informações detalhadas -->
                <div class="mt-2" style="max-width: 310px;">
                    <a href="RH-informações-detalhadas.html" class="btn btn-custom d-block">
                        <i class="bi bi-info-circle-fill position-absolute" style="left: 150px;"></i> Informações Detalhadas
                    </a>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card" style="border-radius: 40px; padding: 0; height: auto;">
                    <div class="d-flex justify-content-center  bg-purple text-white" style="border-radius: 40px 40px 0 0; padding: 20px; position: relative;">
                        <h2 class="m-0">PERFIL</h2>
                        <button class="btn btn-light position-absolute" style="right: 15px; top: 50%; transform: translateY(-50%);" title="Editar Perfil" onclick="openEditModal()">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body bg-light-purple text-dark" style="border-radius: 0 0 40px 40px;">
                        <div class="text-center" style="margin-bottom: 20px;">
                            <h4 class="text-dart perfil-card-subtitle">Informações do colaborador</h4>
                            <hr class="black-line">
                            <h4>Nome:</h4>
                            <br>
                            <h4 id="nome-funcionario">Carregando...</h4>
                            <hr class="black-line">
                            <h4>Departamento:</h4>
                            <br>
                            <h4 id="departamento">Carregando...</h4>
                            <hr class="black-line">
                            <h4>Serviço:</h4>
                            <br>
                            <h4 id="servico">Carregando...</h4>
                            <hr class="black-line">
                            <h4>Cargo:</h4>
                            <br>
                            <h4 id="cargo">Carregando...</h4>
                            <hr class="black-line">
                            <h4>Inatividade:</h4>
                            <br>
                            <h4 id="inatividade">Carregando...</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editForm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Editar Informação</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="editInput" class="form-label">Nova Informação:</label>
                        <input type="text" id="editInput" class="form-control" required>
                        <input type="hidden" id="fieldToEdit">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-light float-end">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Edição Completa do Perfil -->
    <div class="modal fade" id="completeEditModal" tabindex="-1" aria-labelledby="completeEditModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="completeEditForm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="completeEditModalLabel">Editar Perfil Completo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Campos para edição de todas as informações do perfil -->
                        <div class="mb-3">
                            <label for="editNome" class="form-label">Nome:</label>
                            <input type="text" id="editNome" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDepartamento" class="form-label">Departamento:</label>
                            <input type="text" id="editDepartamento" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editServico" class="form-label">Serviço:</label>
                            <input type="text" id="editServico" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCargo" class="form-label">Cargo:</label>
                            <input type="text" id="editCargo" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editInatividade" class="form-label">Inatividade:</label>
                            <select id="editInatividade" class="form-select" required>
                                <option value="Sim">Sim</option>
                                <option value="Não">Não</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-light">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function loadFuncionarioInfo() {
            const viewedFuncionarioId = localStorage.getItem('viewedFuncionarioId'); 
    
            if (!viewedFuncionarioId) {
                alert("ID do funcionário não encontrado.");
                return;
            }
    
            try {
                const response = await fetch(`/funcionario/${viewedFuncionarioId}`);
        
                if (!response.ok) {
                    throw new Error('Erro ao buscar informações do funcionário: ' + response.status);
                }
    
                const funcionario = await response.json();
        
                // Preencher os campos com os dados do funcionário
                document.getElementById('nome-funcionario').textContent = funcionario.nome;
                document.getElementById('contato').textContent = funcionario.contato;
                document.getElementById('codigoFuncionario').textContent = funcionario.codigoFuncionario;
                document.getElementById('turno').textContent = funcionario.turno;
                document.getElementById('departamento').textContent = funcionario.departamento;
                document.getElementById('servico').textContent = funcionario.servico;
                document.getElementById('cargo').textContent = funcionario.cargo;
                document.getElementById('inatividade').textContent = funcionario.inativo ? 'Sim' : 'Não';
        
                const imageUrl = funcionario.fotoPerfil;
                const img = new Image();
                img.src = imageUrl;
                img.onload = () => {
                    document.getElementById('foto-perfil').src = `${imageUrl}?${new Date().getTime()}`;
                };
    
            } catch (error) {
                alert('Erro ao carregar as informações do funcionário.');
            }
        }
    
        // Função para abrir o modal de edição
        function openEditModal(field = null) {
            if (field) {
                // Editando um único campo
                const fieldValue = document.getElementById(field).textContent;
                document.getElementById('editInput').value = fieldValue;
                document.getElementById('fieldToEdit').value = field;
    
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            } else {
                // Editando o perfil completo
                document.getElementById('editNome').value = document.getElementById('nome-funcionario').textContent;
                document.getElementById('editDepartamento').value = document.getElementById('departamento').textContent;
                document.getElementById('editServico').value = document.getElementById('servico').textContent;
                document.getElementById('editCargo').value = document.getElementById('cargo').textContent;
                document.getElementById('editInatividade').value = document.getElementById('inatividade').textContent === 'Sim' ? 'Sim' : 'Não';
    
                const modal = new bootstrap.Modal(document.getElementById('completeEditModal'));
                modal.show();
            }
        }
    
        // Função de envio do formulário de edição para um único campo
        document.getElementById('editForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            await submitEditForm();
        });
    
        // Função de envio do formulário de edição completa
        document.getElementById('completeEditForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            await submitEditForm(true);
        });
    
        // Função que lida com a atualização das informações
        async function submitEditForm(isCompleteEdit = false) {
            const viewedFuncionarioId = localStorage.getItem('viewedFuncionarioId');
            if (!viewedFuncionarioId) {
                alert("ID do funcionário não encontrado.");
                return;
            }
    
            let updatedInfo;
            if (isCompleteEdit) {
                // Edição completa
                updatedInfo = {
                    nome: document.getElementById('editNome').value,
                    departamento: document.getElementById('editDepartamento').value,
                    servico: document.getElementById('editServico').value,
                    cargo: document.getElementById('editCargo').value,
                    inativo: document.getElementById('editInatividade').value === 'Sim'
                };
            } else {
                // Edição de campo individual
                const fieldToEdit = document.getElementById('fieldToEdit').value;
                const newValue = document.getElementById('editInput').value;
                updatedInfo = { [fieldToEdit]: newValue };
            }
    
            try {
                const response = await fetch(`/funcionario/${viewedFuncionarioId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedInfo)
                });
    
                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error('Erro ao atualizar o perfil.');
                }
    
                // Atualizar a interface com os novos dados
                if (isCompleteEdit) {
                    document.getElementById('nome-funcionario').textContent = updatedInfo.nome;
                    document.getElementById('departamento').textContent = updatedInfo.departamento;
                    document.getElementById('servico').textContent = updatedInfo.servico;
                    document.getElementById('cargo').textContent = updatedInfo.cargo;
                    document.getElementById('inatividade').textContent = updatedInfo.inativo ? 'Sim' : 'Não';
                } else {
                    const fieldToEdit = document.getElementById('fieldToEdit').value;
                    const newValue = document.getElementById('editInput').value;
                    document.getElementById(fieldToEdit).textContent = newValue;
                }
    
                // Fechar o modal
                const modalId = isCompleteEdit ? 'completeEditModal' : 'editModal';
                const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
                modal.hide();
    
            } catch (error) {
                alert('Erro ao atualizar o perfil.');
            }
        }
    
        // Função para upload de imagem de perfil
        async function uploadImage() {
            const input = document.getElementById('input-foto');
            const file = input.files[0];
            if (!file) return;
    
            const formData = new FormData();
            formData.append('imagem', file);
    
            const viewedFuncionarioId = localStorage.getItem('viewedFuncionarioId');
            if (!viewedFuncionarioId) {
                alert('ID do funcionário não encontrado.');
                return;
            }
            formData.append('viewedFuncionarioId', viewedFuncionarioId);
    
            try {
                const response = await fetch('/foto/upload', {
                    method: 'POST',
                    body: formData
                });
    
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('foto-perfil').src = `${data.imageUrl}?${new Date().getTime()}`;
                    await loadFuncionarioInfo();
                } else {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (err) {
                        errorData = { message: 'Erro desconhecido ao fazer upload da imagem.' };
                    }
                    alert('Erro ao fazer upload da imagem: ' + errorData.message);
                }
            } catch (error) {
                alert('Erro na conexão com o servidor.');
            }
        }
    
        // Carregar informações do funcionário assim que a página carregar
        loadFuncionarioInfo();
    </script>
    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>