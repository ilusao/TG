<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localidade do Produto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link href="localidade_produto.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
    <div class="header text-center">
        <h1>LOCALIDADE DO PRODUTO</h1>
    </div>

    <div class="menu text-center mb-3">
        <a class="btn btn-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">    
            <i class="bi bi-list"></i> Menu
        </a>
        <ul class="dropdown-menu text-center">
            <h4 style="font-style: italic;">
                <li><a class="dropdown-item" href="#">Estoque</a></li>
                <li><a class="dropdown-item" href="#">Fornecedor</a></li>
                <li><a class="dropdown-item" href="#">Cadastrar Produto</a></li>
                <li><a class="dropdown-item" href="#">Cadastrar Fornecedor</a></li>
                <li><a class="dropdown-item" href="#">Cadastrar Funcionário</a></li>
            </h4>
        </ul>
    </div>

    <div class="map-container">
        <div id="map" style="height: 600px;"></div>
        <div class="error-message" id="error-message" style="display: none;"></div>
        
        <div class="form-overlay">
            <h3>Localizar Produto</h3>
            <div class="mb-2">
                <label for="codigoProduto" class="form-label">Código do Produto</label>
                <input type="text" class="form-control" id="codigoProduto" placeholder="Insira o código do produto">
            </div>
            <div class="mb-2">
                <label for="localizacao" class="form-label">Localização</label>
                <input type="text" class="form-control" id="localizacao" placeholder="Digite uma localização para pesquisar">
            </div>
            <br>
            <div class="d-flex justify-content-center mb-2">
                <button id="buscarLocal" class="btn btn-primary">Buscar Localização</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar o mapa em Itu
        var map = L.map('map').setView([-23.2644, -47.2992], 13);
        var errorMessage = document.getElementById('error-message');

        // Função para lidar com a inicialização do mapa
        function initMap() {
            try {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            } catch (error) {
                showErrorMessage("Infelizmente, o OpenStreetMap está fora do ar.");
            }
        }

        // Função para exibir mensagens de erro
        function showErrorMessage(message) {
            errorMessage.innerText = message;
            errorMessage.style.display = 'block'; // Torna a mensagem visível
        }

        // Carregar todos os produtos no mapa ao carregar a página
        async function carregarProdutos() {
            try {
                const response = await fetch('/api/buscarProdutos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const produtos = await response.json();

                if (response.ok && produtos.length > 0) {
                    produtos.forEach(async (produto) => {
                        if (produto.localizacao) {
                            try {
                                const responseLoc = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${produto.localizacao}`);
                                if (!responseLoc.ok) {
                                    throw new Error("Falha ao buscar localização");
                                }

                                const dataLoc = await responseLoc.json();

                                if (dataLoc.length > 0) {
                                    const { lat, lon } = dataLoc[0];
                                    L.marker([lat, lon]).addTo(map).bindPopup(`
                                        <b>Produto:</b> ${produto.nome} <br>
                                        <b>Localização:</b> ${produto.localizacao} <br>
                                        <b>Código:</b> ${produto.codigo_produto}
                                    `);
                                } else {
                                    console.warn(`Localização "${produto.localizacao}" não encontrada.`);
                                }
                            } catch (error) {
                                console.error('Erro ao buscar localização:', error);
                                showErrorMessage("Infelizmente, não conseguimos se conectar ao OpenStreetMap para buscar a localização.");
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }

        let tempLocationMarker = null; // Variável para armazenar o marcador temporário

        document.getElementById('codigoProduto').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                buscarProdutoPorCodigo();
            }
        });

        document.getElementById('localizacao').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                buscarLocalizacao();
            }
        });

        async function buscarProdutoPorCodigo() {
            const codigoProduto = document.getElementById('codigoProduto').value;

            if (!codigoProduto) {
                alert("Digite um código de produto para pesquisar.");
                return;
            }

            try {
                const response = await fetch('/api/buscarProdutos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigo_produto: codigoProduto })
                });

                const produtos = await response.json();

                if (response.ok && produtos.length > 0) {
                    produtos.forEach(async (produto) => {
                        if (produto.localizacao) {
                            try {
                                const responseLoc = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${produto.localizacao}`);
                                if (!responseLoc.ok) {
                                    throw new Error("Falha ao buscar localização");
                                }
                                const dataLoc = await responseLoc.json();

                                if (dataLoc.length > 0) {
                                    const { lat, lon } = dataLoc[0];

                                    // Adiciona o marcador do produto e centraliza o mapa
                                    const productMarker = L.marker([lat, lon]).addTo(map).bindPopup(`
                                        <b>Produto:</b> ${produto.nome} <br>
                                        <b>Localização:</b> ${produto.localizacao} <br>
                                        <b>Código:</b> ${produto.codigo_produto}
                                    `);
                                    
                                    map.setView([lat, lon], 13);
                                    productMarker.openPopup();
                                } else {
                                    console.warn(`Localização "${produto.localizacao}" não encontrada.`);
                                }
                            } catch (error) {
                                console.error('Erro ao buscar localização:', error);
                                showErrorMessage("Infelizmente, não conseguimos se conectar ao OpenStreetMap para buscar a localização.");
                            }
                        }
                    });
                } else {
                    alert('Produto não encontrado.');
                }
            } catch (error) {
                console.error('Erro ao buscar produto por código:', error);
            }
        }

        // Função para buscar uma localização específica quando não se usa Enter no código do produto
        async function buscarLocalizacao() {
            const localizacaoInput = document.getElementById('localizacao').value;

            if (!localizacaoInput) {
                alert("Digite uma localização para pesquisar.");
                return;
            }

            try {
                const responseLoc = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${localizacaoInput}`);
                if (!responseLoc.ok) {
                    throw new Error("Falha ao buscar localização");
                }
                const dataLoc = await responseLoc.json();

                if (dataLoc.length > 0) {
                    const { lat, lon } = dataLoc[0];
                    
                    if (tempLocationMarker) {
                        map.removeLayer(tempLocationMarker);
                    }
                    tempLocationMarker = L.marker([lat, lon]).addTo(map).bindPopup(`Localização: ${localizacaoInput}`);
                    map.setView([lat, lon], 13);
                } else {
                    alert('Localização não encontrada.');
                }
            } catch (error) {
                console.error('Erro ao buscar localização:', error);
                showErrorMessage("Infelizmente, não conseguimos se conectar ao OpenStreetMap para buscar a localização.");
            }
        }

        document.getElementById('buscarLocal').addEventListener('click', buscarLocalizacao);

        window.onload = function() {
            initMap();
            carregarProdutos();
        }
    </script>
</body>
</html>
