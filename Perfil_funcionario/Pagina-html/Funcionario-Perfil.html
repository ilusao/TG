<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Funcionário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../Pagina-css/Funcionario-Perfil.css">
</head>
<body>
    <div class="container mt-3">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="position-relative">
                    <img id="foto-perfil" src="/midia/fotooriginal.png" alt="Foto de Perfil" class="img-fluid rounded-4" style="max-width: 310px; height: 300px;">
                    <button id="editar-foto" class="btn btn-light position-absolute" style="top: 8px; right: 115px;" title="Editar Foto" onclick="document.getElementById('input-foto').click();">
                        <i class="bi bi-camera fs-5"></i>
                    </button>
                    <form id="form-foto" style="display: none;">
                        <input type="file" id="input-foto" name="fotoPerfil" accept="image/*" onchange="uploadImage()">
                    </form>
                </div>

                <!-- Contato -->
                <div class="card mt-2 bg-light-purple" style="border-radius: 40px; max-width: 310px; height: 120px;">
                    <div class="card-header text-white text-center bg-purple" style="border-radius: 40px 40px 0 0;">
                        <i class="bi bi-telephone fs-4" style="position: absolute; left: 15px;"></i>
                        <span>Contato</span>
                        <button class="btn btn-light float-end" title="Editar Contato" onclick="openEditModal('contato')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body text-center text-white">
                        <p id="contato">Carregando...</p>
                    </div>
                </div>

                <!-- Horário de trabalho -->
                <div class="card mt-2 bg-light-purple" style="border-radius: 40px; max-width: 310px; height: 120px;">
                    <div class="card-header text-white text-center bg-purple fs-5" style="border-radius: 40px 40px 0 0;">
                        <i class="bi bi-clock fs-4" style="position: absolute; left: 15px;"></i> Horário de Trabalho
                        <button class="btn btn-light float-end" title="Editar Horário" onclick="openEditModal('horario-trabalho')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body text-center text-white">
                        <p id="horario-trabalho">Carregando...</p>
                    </div>
                </div>

                <!-- Código do Funcionário -->
                <div class="card mt-2 bg-danger" style="border-radius: 40px; max-width: 310px; height: 120px;"> 
                    <div class="card-header text-white text-center bg-purple fs-5" style="border-radius: 40px 40px 0 0;">
                        <i class="bi bi-person-badge-fill fs-4" style="position: absolute; left: 15px;"></i>
                        <span>Código do Funcionário</span>
                        <button class="btn btn-light float-end" title="Editar Código" onclick="openEditModal('codigo-funcionario')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body text-center text-white bor">
                        <p id="codigo-funcionario">Carregando...</p>
                    </div>
                </div>

                <!-- Botão de informações detalhadas -->
                <div class="mt-2" style="max-width: 310px;">
                    <a href="#" class="btn btn-custom d-block">
                        <i class="bi bi-info-circle-fill" style="position: absolute; left: 150px;"></i> Informações Detalhadas
                    </a>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card" style="border-radius: 40px; padding: 0; height: auto;">
                    <div class="text-center bg-purple" style="border-radius: 40px 40px 0 0; padding: 20px;">
                        <h2 class="text-white">
                            PERFIL
                            <button class="btn btn-light float-end fs-4" title="Editar Perfil" onclick="openEditModal('nome-funcionario')">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </h2>
                    </div>
                    <div class="card-body bg-light-purple text-white" style="border-radius: 0 0 40px 40px;">
                        <div class="text-center" style="margin-bottom: 20px;">
                            <h4 class="text-white perfil-card-subtitle">Informações compartilhadas pelo funcionário</h4>
                            <hr class="black-line">
                            <h4>NOME:</h4>
                            <br>
                            <h4 id="nome-funcionario" class="info-text-data">Carregando...</h4>
                            <hr class="black-line">
                            <h4>DEPARTAMENTO:</h4>
                            <br>
                            <h4 id="departamento">Carregando...</h4>
                            <hr class="black-line">
                            <h4>SERVIÇO:</h4>
                            <br>
                            <h4 id="servico">Carregando...</h4>
                            <hr class="black-line">
                            <h4>CARGO:</h4>
                            <br>
                            <h4 id="cargo">Carregando...</h4>
                            <hr class="black-line">
                            <h4>Inatividade:</h4>
                            <br>
                            <h4 id="inatividade">Carregando...</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais para Edição -->
    <!-- Modal de Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editForm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Editar Informação</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="editInput" class="form-label">Nova Informação:</label>
                        <input type="text" id="editInput" class="form-control" required>
                        <input type="hidden" id="fieldToEdit">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function loadFuncionarioInfo() {
            const funcionarioId = localStorage.getItem('funcionarioId'); 
            console.log("ID do Funcionário:", funcionarioId);

            if (!funcionarioId) {
                alert("ID do funcionário não encontrado.");
                return;
            }

            try {
                const response = await fetch(`/funcionario/${funcionarioId}`);
                if (!response.ok) {
                    throw new Error('Erro ao buscar informações do funcionário: ' + response.status);
                }
                const funcionario = await response.json();

                // Preencher os campos com os dados do funcionário
                document.getElementById('nome-funcionario').textContent = funcionario.nome;
                document.getElementById('contato').textContent = funcionario.contato;
                document.getElementById('codigo-funcionario').textContent = funcionario.codigoFuncionario;
                document.getElementById('horario-trabalho').textContent = funcionario.turno;
                document.getElementById('departamento').textContent = funcionario.departamento;
                document.getElementById('servico').textContent = funcionario.servico;
                document.getElementById('cargo').textContent = funcionario.cargo;
                document.getElementById('inatividade').textContent = funcionario.inativo ? 'Sim' : 'Não';

                // Atualize a imagem do perfil
                const imageUrl = funcionario.fotoPerfil || '/midia/fotooriginal.png';
                const img = new Image();

                img.src = imageUrl; // Tente carregar a imagem

                img.onload = () => {
                    // Se a imagem carregar corretamente, atualize a src
                    document.getElementById('foto-perfil').src = `${imageUrl}?${new Date().getTime()}`; // Previne cache
                };

                img.onerror = () => {
                    // Se houver erro ao carregar a imagem, use a imagem padrão
                    document.getElementById('foto-perfil').src = '/midia/fotooriginal.png';
                };

            } catch (error) {
                console.error(error);
                alert('Não foi possível carregar as informações do funcionário: ' + error.message);
            }
        }

        async function uploadImage() {
            console.log("Função uploadImage chamada.");
            const input = document.getElementById('input-foto');
            const file = input.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('imagem', file);

            const funcionarioId = localStorage.getItem('funcionarioId');
            if (!funcionarioId) {
                alert('ID do funcionário não encontrado.');
                return;
            }
            formData.append('funcionarioId', funcionarioId);

            try {
                const response = await fetch('/foto/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Nova URL da imagem:", data.imageUrl); 
                    document.getElementById('foto-perfil').src = `${data.imageUrl}?${new Date().getTime()}`; // Previne cache
                    
                    // Recarrega as informações do funcionário para atualizar todos os campos
                    await loadFuncionarioInfo();
                } else {
                    const errorData = await response.json();
                    console.error('Erro ao fazer upload da imagem:', errorData);
                    alert('Erro ao fazer upload da imagem: ' + errorData.message);
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // Função para abrir o modal de edição
        function openEditModal(field) {
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            document.getElementById('editModalLabel').textContent = `Editar ${capitalizeFirstLetter(field.replace('-', ' '))}`;
            document.getElementById('editInput').value = document.getElementById(field).textContent;
            document.getElementById('fieldToEdit').value = field;
            modal.show();
        }

        // Função para tratar a submissão do formulário de edição
        document.getElementById('editForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const newValue = document.getElementById('editInput').value.trim();
            const field = document.getElementById('fieldToEdit').value;
            const funcionarioId = localStorage.getItem('funcionarioId');

            if (!newValue) {
                alert('O campo não pode estar vazio.');
                return;
            }

            try {
                const response = await fetch(`/funcionario/${funcionarioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ [mapFieldToDb(field)]: newValue })
                });

                if (response.ok) {
                    const updatedFuncionario = await response.json();
                    // Atualiza o campo na página
                    document.getElementById(field).textContent = updatedFuncionario[mapFieldToDb(field)] || 'Não informado';
                    // Fecha o modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    modal.hide();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao atualizar informação.');
                }
            } catch (error) {
                console.error(error);
                alert('Não foi possível atualizar a informação: ' + error.message);
            }
        });

        // Função para mapear os campos do HTML para os campos do banco de dados
        function mapFieldToDb(field) {
            const mapping = {
                'contato': 'contato',
                'horario-trabalho': 'turno',
                'codigo-funcionario': 'codigoFuncionario',
                'nome-funcionario': 'nome'
                // Adicione mais mapeamentos conforme necessário
            };
            return mapping[field] || field;
        }

        // Função para capitalizar a primeira letra
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Carrega as informações do funcionário quando a página é carregada
        window.onload = loadFuncionarioInfo;
    </script>

    <!-- Scripts Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
